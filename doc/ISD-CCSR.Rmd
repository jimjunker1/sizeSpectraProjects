---
author: Jim Junker
date: '`r format(Sys.Date())`'
title: ISD-CCSR comparison
output: html_document
---

```{r init, echo = FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
here::i_am("doc/ISD-CCSR.Rmd")
```


## Purpose

Start the initial analysis combining ISD, CCSR, and LSD relationships across the NEON sites. This is initial fodder for discussion of next steps.

## Introduction
[
The negative relationship between abundance and body size is one of the most widely observed ecological patterns []. This relationships manifests across biological levels of organization from individuals within a species to whole food webs [@white2007].


```{r load data}
library(here)
library(tidyverse)
library(tidybayes)
library(ggdist)
library(modelr)
library(rstan)
library(brms)
library(viridis)
library(mgcv)
theme_set(theme_minimal())

# read in data and calc sample level summaries
dw_dat = readRDS(here("./data/dat_fish_inverts_dw_allyears.rds")) %>% 
  group_by(site_id, sample_id) %>% 
  mutate(n_sum = sum(no_m2),
         n_rel = no_m2/n_sum,
         b_m2 = no_m2*dw,
         b_sum = sum(b_m2),
         b_rel = b_m2/b_sum)

# get weighted mean body size
dw_dat_summ = dw_dat %>% 
  group_by(site_id, sample_id) %>% 
  summarise(n_tot = sum(n_sum),
            ln_tot = log10(n_tot),
            mbar_n = weighted.mean(dw, w = n_rel),
            mbar_b = weighted.mean(dw, w = b_rel),
            lmbar_n = log10(mbar_n),
            lmbar_b = log10(mbar_b),
            b_m2 = unique(b_sum)) %>% 
  ungroup %>% 
  mutate(across(all_of(c("ln_tot", "lmbar_n","lmbar_b")), ~as.numeric(scale(.)), .names  = "{.col}_s"))%>% 
  left_join(dw_dat %>% ungroup %>% select(site_id, gpp, log_gpp_s, log_om_s, mat_s) %>% distinct(), by = 'site_id')

# read in lambdas by sample_id
lambdas = read_csv(here("data/post_sample_lambdas.csv")) %>% 
  select(sample_id, lambda_med = '.epred', lower_lambda = '.lower', upper_lambda = '.upper') 

dw_dat_summ = merge(dw_dat_summ, lambdas, by = 'sample_id', all = TRUE) 

```

```{r models}
## calculate the bayesian linear regression

output = capture.output(brm(bf(ln_tot_s~lmbar_n_s),
              data = dw_dat_summ,
              family = gaussian(link = 'identity'),
              iter = 1000,
              thin = 1,
              file_refit = 'on_change',
              file = here("data/models/N_M_nwt"),
              chains = 4, cores = 4,
              seed = 1312
              )
)
NM_nwt = readRDS(here("data/models/N_M_nwt.rds"))
NM_nwt_int =fixef(NM_nwt)[1,'Estimate']

NM_nwt_pred = dw_dat_summ %>% 
  data_grid(lmbar_n_s = seq_range(lmbar_n_s, n = 51)) %>% 
  mutate(pred = NM_nwt_int + lmbar_n_s*-1)


output = capture.output(brm(bf(ln_tot_s~lmbar_b_s),
              data = dw_dat_summ,
              family = gaussian(link = 'identity'),
              iter = 1000,
              thin = 1,
              file_refit = 'on_change',
              file = here("data/models/N_M_bwt"),
              chains = 4, cores = 4,
              seed = 1312
              ))
NM_bwt = readRDS(here("data/models/N_M_bwt.rds"))
NM_bwt_int =fixef(NM_bwt)[1,'Estimate']

NM_bwt_pred = dw_dat_summ %>% 
  data_grid(lmbar_b_s = seq_range(lmbar_b_s, n = 51)) %>% 
  mutate(pred = NM_bwt_int + lmbar_b_s*-1)

```

While the calculation of total abundance is straightforward, estimating mean body size of the community can be done in multiple ways: 1) by taking the mean of all individuals (i.e., abundance-weighted mean) or by calculating the relative biomass of each body size and using this to weight the mean by relative biomass (i.e., biomass-weighted). Because the relationship between abundance and body size is based on energy use, i.e. metabolism, and metabolism scales non-linearly with body size, biomass weighting is the most appropriate choice. Below 


```{r N-Mn plot, fig.cap='Figure 1. The scaling of community abundances by community abundance-weighted body size across the NEON streams.'}

# create label vector for scaled breaks. s 

dw_dat_summ %>% 
data_grid(lmbar_n_s = seq_range(lmbar_n_s, n = 51)) %>%
  add_epred_draws(NM_nwt, ndraws = 100) %>% 
  ggplot()+
  geom_line(data = NM_nwt_pred, aes(x = lmbar_n_s, y = pred), linewidth = 1.1, linetype = 'dotted', color = 'darkgrey')+
  geom_point(data = dw_dat_summ, aes(x = lmbar_n_s, y = ln_tot_s, color = site_id))+
  geom_line(aes(x = lmbar_n_s, y = .epred, group = .draw), alpha = 0.1)+
  geom_smooth(data = dw_dat_summ, aes(x = lmbar_n_s, y = ln_tot_s), se = FALSE, method = 'gam')+
  scale_color_viridis(discrete = TRUE)+
  scale_y_continuous(name = expression(log[10]*"(N)"), limits = c(-3.5, 3.5), expand = c(0,0), breaks = seq.int(-3,3, by = 2))+#, labels = format(10^seq.int(3,7, by = 2), scientific = TRUE))+
  scale_x_continuous(name = expression(log[10]*"("*bar(M)["abun-weighted"]*")"), limits = c(-3,4.51), breaks = seq.int(-3,3, by = 2))+#, labels = scales::scientific(10^seq.int(-1,2.5, by = 2)))+
  theme(legend.position = 'none')
```

```{r N-Mb plot,fig.cap='Figure 2. The scaling of community abundances by community biomass-weighted body size across the NEON streams.'}

dw_dat_summ %>% 
data_grid(lmbar_b_s = seq_range(lmbar_b_s, n = 51)) %>%
  add_epred_draws(NM_bwt, ndraws = 100) %>% 
  ggplot()+
  geom_line(data = NM_bwt_pred, aes(x = lmbar_b_s, y = pred), linewidth = 1.1, linetype =   'dotted', color = 'darkgrey')+
  geom_point(data = dw_dat_summ, aes(x = lmbar_b_s, y = ln_tot_s, color = site_id))+
  geom_line(aes(x = lmbar_b_s, y = .epred, group = .draw), alpha = 0.1)+
  geom_smooth(data = dw_dat_summ, aes(x = lmbar_b_s, y = ln_tot_s), se = FALSE, method = 'gam')+
  scale_color_viridis(discrete = TRUE)+
  scale_y_continuous(name = expression(log[10]*"(N)"), limits = c(-3, 3), expand = c(0,0), breaks = seq.int(-3,3, by = 2))+#, labels = format(10^seq.int(3,8, by = 2), scientific = TRUE))+
  scale_x_continuous(name = expression(log[10]*"("*bar(M)["biomass-weighted"]*")"), limits = c(-3.5,3), breaks = seq.int(-3,3, by = 2))+#, labels = scales::scientific(10^seq.int(-1,5, by = 2)))+
  theme(legend.position = 'none')
```


```{r residual analysis}

NMbarN_res = residuals(NM_nwt) %>%  data.frame %>% select(NMnwt_res = 'Estimate', NMnwt_2.5 = 'Q2.5', NMnwt_97.5 = 'Q97.5')
NMbarB_res = residuals(NM_bwt) %>% data.frame %>% select(NMbwt_res = 'Estimate', NMbwt_2.5 = 'Q2.5', NMbwt_97.5 = 'Q97.5')

dw_dat_summ = dw_dat_summ %>% bind_cols(NMbarN_res) %>% bind_cols(NMbarB_res)

isd_NMnwt_plot = dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = NMnwt_res, y = lambda_med, color = site_id))+
  scale_color_viridis(discrete = TRUE)+
  labs(subtitle = expression("N-"*M['abun-weighted']))+
  theme(legend.position = 'none')

isd_NMbwt_plot = dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = NMbwt_res, y = lambda_med, color = site_id))+
  scale_color_viridis(discrete = TRUE)+
  labs(subtitle = expression("N-"*M['biomass-weighted']))+
  theme(legend.position = 'none')

gridExtra::grid.arrange(isd_NMnwt_plot, isd_NMbwt_plot, ncol =1)

```

```{r env plots}

## relationships with temperature
output = capture.output(brm(bf(ln_tot~1 + mat_s + I(mat_s^2)), 
            data = dw_dat_summ,
            family = gaussian(link = 'identity'),
            iter = 1000,
            thin = 1, 
            file_refit = 'on_change',
            file = here("data/models/N_mat_gam"),
            chains = 4, cores = 4,
            seed = 1312
            ))

N_mat = readRDS(here("data/models/N_mat_gam.rds"))

dw_dat_summ %>% 
  data_grid(mat_s = seq_range(mat_s, n = 51)) %>% 
  add_epred_draws(N_mat, ndraws= 100) %>% 
  ggplot()+
  geom_line(aes(x = mat_s, y = .epred, group = .draw), alpha = .1)+
  geom_point(data = dw_dat_summ, aes(x = mat_s, y = ln_tot, color = site_id), size = 2)+
  scale_color_viridis(discrete = TRUE)+
  scale_y_continuous(name = expression(log[10]*"(N)"), limits = c(3, 8), expand = c(0,0), breaks = seq.int(3,8, by = 2), labels = format(10^seq.int(3,8, by = 2), scientific = TRUE))+
  scale_x_continuous(name = "mat_s")+
  theme(legend.position = 'none')

output = capture.output(brm(bf(log10(b_m2)~1 + mat_s + I(mat_s^2)), 
            data = dw_dat_summ,
            family = gaussian(link = 'identity'),
            iter = 1000,
            thin = 1, 
            file_refit = 'on_change',
            file = here("data/models/B_mat_gam"),
            chains = 4, cores = 4,
            seed = 1312
            ))

B_mat = readRDS(here("data/models/B_mat_gam.rds"))

dw_dat_summ %>% 
  data_grid(mat_s = seq_range(mat_s, n = 51)) %>% 
  add_epred_draws(B_mat, ndraws= 100) %>% 
  ggplot()+
  geom_line(aes(x = mat_s, y = .epred, group = .draw), alpha = .1)+
  geom_point(data = dw_dat_summ, aes(x = mat_s, y = log10(b_m2), color = site_id), size = 2)+
  scale_color_viridis(discrete = TRUE)+
  scale_y_continuous(name = expression(log[10]*"(B)"), limits = c(2, 6), expand = c(0,0), breaks = seq.int(2,6, by = 2), labels = format(10^seq.int(2,6, by = 2), scientific = TRUE))+
  scale_x_continuous(name = "mat_s")+
  theme(legend.position = 'none')
```

```{r isd-ccsr}
# dw_dat_summ %>% 
#   ggplot()+
#   geom_point(aes(x = ))

```




```{r N and B models}

## relationships with gpp
dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = log_gpp_s, y = ln_tot))+
  geom_smooth(aes(x = log_gpp_s, y = ln_tot), se = FALSE)

dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = log_gpp_s, y = log10(b_m2)))+
  geom_smooth(aes(x = log_gpp_s, y = log10(b_m2)), se = FALSE)

## relationship with om
dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = log_om_s, y = ln_tot))+
  geom_smooth(aes(x = log_om_s, y = ln_tot), se = FALSE)

dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = log_om_s, y = log10(b_m2)))+
  geom_smooth(aes(x = log_om_s, y = log10(b_m2)), se = FALSE)

# relationship of Mbar with mat

dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = mat_s, y = lmbar_n))+
  geom_smooth(aes(x = mat_s, y = lmbar_n), se=FALSE)


dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = mat_s, y = lmbar_b))+
  geom_smooth(aes(x = mat_s, y = lmbar_b), se=FALSE)

# relationship of Mbar with mat

dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = log_gpp_s, y = lmbar_n))+
  geom_smooth(aes( x = log_gpp_s, y = lmbar_n), se = FALSE)


dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = log_gpp_s, y = lmbar_b))+
  geom_smooth(aes(x = log_gpp_s, y = lmbar_b), se = FALSE)

# relationship of Mbar with mat

dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = log_om_s, y = lmbar_n))+
  geom_smooth(aes(x = log_om_s, y = lmbar_n), se = FALSE)


dw_dat_summ %>% 
  ggplot()+
  geom_point(aes(x = log_om_s, y = lmbar_b))+
  geom_smooth(aes(x = log_om_s, y = lmbar_b), se = FALSE)


```






